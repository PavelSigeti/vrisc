import{_ as R,Y as H,u as M,r as d,o as n,c as p,b as e,F as k,P as C,Q as A,g as L,S as I,Z as S,f as b,I as O,J,x as N,j as y,h as P,a as T,d as $,X as Q,w as X,e as V,U as Y}from"./app.e959e466.js";import{A as Z}from"./AppResultTable.a90e68bc.js";import{A as z}from"./logo.4abce9f2.js";import{A as K}from"./AppEditor.cd5a2964.js";import{A as W}from"./AppHeader.e20ac1c6.js";const tt=o=>(O("data-v-56d41fc1"),o=o(),J(),o),et={key:0,class:"result-table"},at=tt(()=>e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"\u042F\u0445\u0442\u0441\u043C\u0435\u043D"),e("th",null,"\u0413\u0440\u0443\u043F\u043F\u0430"),e("th",null,"\u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435")])],-1)),st={class:"result-table__name"},ot={class:"result-table__nick"},rt=["onUpdate:modelValue"],nt=["onClick"],lt={__name:"AppUsersTablesEdit",props:{id:{type:[String,Number],required:!0},users:{type:Array,default:()=>[]},status:{type:String,required:!0}},emits:["create-groups","users-updated"],setup(o,{emit:a}){const i=o;H();const t=M(),f=d(i.status),g=d({});(r=>{const u={};r&&r.length>0&&r.forEach(m=>{u[m.id]=1}),g.value=u})(i.users);const l=()=>{if(!i.users.every(s=>g.value[s.id]!==void 0&&g.value[s.id]!==null&&g.value[s.id]>=1))return t.dispatch("notification/displayMessage",{type:"error",value:"\u041D\u0435 \u0432\u0441\u0435 \u044F\u0445\u0442\u0441\u043C\u0435\u043D\u044B \u0440\u0430\u0441\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u044B \u043F\u043E \u0433\u0440\u0443\u043F\u043F\u0430\u043C"}),!1;const u=Object.values(g.value),m=[...new Set(u)].sort((s,v)=>s-v);for(let s=0;s<m.length;s++)if(m[s]!==s+1)return t.dispatch("notification/displayMessage",{type:"error",value:`\u041D\u043E\u043C\u0435\u0440\u0430 \u0433\u0440\u0443\u043F\u043F \u0434\u043E\u043B\u0436\u043D\u044B \u043D\u0430\u0447\u0438\u043D\u0430\u0442\u044C\u0441\u044F \u0441 1 \u0438 \u0438\u0434\u0442\u0438 \u043F\u043E\u0441\u043B\u0435\u0434\u043E\u0432\u0430\u0442\u0435\u043B\u044C\u043D\u043E. \u041E\u0431\u043D\u0430\u0440\u0443\u0436\u0435\u043D\u0430 \u0433\u0440\u0443\u043F\u043F\u0430 \u2116${m[s]}`}),!1;return!0},h=async()=>{var r,u,m,s;try{if(!l())return;const v={};i.users.forEach(w=>{v[w.id]=parseInt(g.value[w.id])||1});const x=await axios.post(`/api/admin/stage/${i.id}/create-manual-groups`,{groups:v});x.data.result?(f.value=x.data.status,a("create-groups",x.data.status),t.dispatch("notification/displayMessage",{type:"primary",value:"\u0413\u0440\u0443\u043F\u043F\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0441\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0438 \u044D\u0442\u0430\u043F \u043D\u0430\u0447\u0430\u0442"})):t.dispatch("notification/displayMessage",{type:"error",value:x.data.msg||x.data.error||"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0438 \u0433\u0440\u0443\u043F\u043F"})}catch(v){console.error("Error creating groups:",v),t.dispatch("notification/displayMessage",{type:"error",value:((u=(r=v.response)==null?void 0:r.data)==null?void 0:u.message)||((s=(m=v.response)==null?void 0:m.data)==null?void 0:s.msg)||"\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430"})}},U=async r=>{const u=await axios.post(`/api/admin/stage/${i.id}/remove-user/${r}`);u.data.result?(a("users-updated"),t.dispatch("notification/displayMessage",{type:"primary",value:"\u0423\u0447\u0430\u0441\u0442\u043D\u0438\u043A \u0443\u0434\u0430\u043B\u0435\u043D"})):t.dispatch("notification/displayMessage",{type:"error",value:u.data.msg})};return(r,u)=>(n(),p(k,null,[i.users&&i.users.length>0?(n(),p("table",et,[at,e("tbody",null,[(n(!0),p(k,null,C(i.users,(m,s)=>(n(),p("tr",{key:m.id||s},[e("td",null,A(s+1),1),e("td",null,[e("div",st,[L(A(m.surname)+" "+A(m.name)+" ",1),e("span",ot,A(m.nickname),1)])]),e("td",null,[I(e("input",{class:"split-number-input",type:"number","onUpdate:modelValue":v=>g.value[m.id]=v,min:"1"},null,8,rt),[[S,g.value[m.id]]])]),e("td",null,[e("button",{class:"btn btn-default btn-settings",onClick:v=>U(m.id)},"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",8,nt)])]))),128))])])):b("",!0),i.users&&i.users.length>0?(n(),p("button",{key:1,class:"btn btn-default btn-settings mt15",onClick:h}," \u0421\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0433\u0440\u0443\u043F\u043F\u044B ")):b("",!0)],64))}},it=R(lt,[["__scopeId","data-v-56d41fc1"]]),ct={name:"AppRaceColumn",props:["raceId"],emits:["update"],setup(o,{emit:a}){const i=M(),t=d([]),f=d(0);return N(async()=>{const _=await y.get(`/api/admin/race/${o.raceId}`);t.value=_.data,f.value=Object.keys(t.value).length+1}),{submit:async()=>{try{await y.post(`/api/admin/race/${o.raceId}/results`,{result:t.value}),i.dispatch("notification/displayMessage",{value:"\u0414\u0430\u043D\u043D\u044B\u0435 \u0433\u043E\u043D\u043A\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u044B",type:"primary"}),a("update")}catch{i.dispatch("notification/displayMessage",{value:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0433\u043E\u043D\u043A\u0438",type:"error"})}},result:t,userAmount:f}}},dt=["onUpdate:modelValue","placeholder"],ut={class:"race-table__item race-table__result"};function pt(o,a,i,t,f,g){return n(),p(k,null,[(n(!0),p(k,null,C(t.result,(_,l)=>(n(),p("div",{class:"race-table__item race-table__result",key:l},[I(e("input",{type:"text","onUpdate:modelValue":h=>t.result[l]=h,placeholder:`(dnf, ${t.userAmount})`},null,8,dt),[[S,t.result[l]]])]))),128)),e("div",ut,[e("button",{onClick:a[0]||(a[0]=(..._)=>t.submit&&t.submit(..._))},"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C")])],64)}const _t=R(ct,[["render",pt]]),mt={name:"AppRaceTable",props:["stageId","status","groupId"],components:{AppRaceColumn:_t},setup(o){const a=d({}),i=d({}),t=d(),f=d(),g=d({default:"\u0413\u043E\u043D\u043A\u0430",group:"\u0413\u0440\u0443\u043F\u043F\u0430",fleet:"\u0424\u043B\u043E\u0442"}),_=P(()=>{var r;return(r=Object.keys(a.value).length)!=null?r:0}),l=async()=>{try{const r=await y.get(`/api/admin/stage/${o.stageId}/${o.groupId}/${o.status}/total`);f.value=r.data}catch(r){console.log(r.message)}};return N(async()=>{try{const r=await y.get(`/api/admin/stage/${o.stageId}/races/${o.status}/group/${o.groupId}`);a.value=r.data,t.value=a.value[0].race_id;const u=await y.get(`/api/admin/race/${t.value}/users`);i.value=u.data,await l()}catch(r){console.log(r.message)}}),{raceData:a,raceAmount:_,usersData:i,addRace:async()=>{try{const u=(await y.post("/api/admin/race/create",{stage_id:o.stageId,group_id:o.groupId,status:o.status,lastRaceId:t.value})).data;a.value.push({race_id:u.id,group_id:u.group_id,status:u.status}),await l()}catch(r){console.log(r.message)}},remove:async r=>{try{await y.post(`/api/admin/race/${r}/remove`),a.value.splice(a.value.findIndex(u=>u.race_id===r),1),await l()}catch(u){console.log(u.message)}},totalData:f,getTotal:l,raceTitle:g}}},gt={class:"race-table"},vt={key:0},ft={class:"race-table__header"},ht={class:"race-table__row"},bt=e("div",{class:"race-table__item race-table__name"},"\u042F\u0445\u0442\u0441\u043C\u0435\u043D",-1),yt=e("div",{class:"race-table__item race-table__total"},"\u0418\u0442\u043E\u0433",-1),xt={class:"race-table__body"},kt={class:"race-table__column"},At={key:0,class:"race-table__item race-table__result"},Ut=["onClick"],wt={class:"race-table__column"};function It(o,a,i,t,f,g){const _=T("AppRaceColumn");return n(),p("div",gt,[o.$props.status?(n(),p("h2",vt,A(t.raceTitle[o.$props.status])+" #"+A(o.$props.groupId),1)):b("",!0),e("button",{class:"btn btn-default btn-settings mb15",onClick:a[0]||(a[0]=(...l)=>t.addRace&&t.addRace(...l))},"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0433\u043E\u043D\u043A\u0443"),e("div",ft,[e("div",ht,[bt,(n(!0),p(k,null,C(t.raceAmount,l=>(n(),p("div",{class:"race-table__item race-table__result",key:l},"#"+A(l),1))),128)),yt])]),e("div",xt,[e("div",kt,[(n(!0),p(k,null,C(t.usersData,l=>(n(),p("div",{class:"race-table__item race-table__name",key:l.user_id},A(l.nickname),1))),128))]),(n(!0),p(k,null,C(t.raceData,(l,h)=>(n(),p("div",{class:"race-table__column",key:l.race_id},[$(_,{raceId:l.race_id,onUpdate:t.getTotal},null,8,["raceId","onUpdate"]),t.raceData.length>1&&h+1!==1?(n(),p("div",At,[e("button",{onClick:U=>t.remove(l.race_id)},"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",8,Ut)])):b("",!0)]))),128)),e("div",wt,[(n(!0),p(k,null,C(t.totalData,(l,h)=>(n(),p("div",{class:"race-table__item race-table__total",key:h},A(l),1))),128))])])])}const St=R(mt,[["render",It]]),Vt={name:"TheStageStatus",emits:["update"],props:["status","id"],setup(o,{emit:a}){const i=d(o.status),t=o.id,f=M();return{status:i,id:t,finishStage:async()=>{try{const _=await y.post(`/api/admin/stage/${t}/finish`);i.value=_.data.status,a("update",i.value)}catch(_){console.log(_.message),f.dispatch("notification/displayMessage",{value:_.response.data.message,type:"error"})}}}}};function Tt(o,a,i,t,f,g){return t.status==="default"||t.status==="group"?(n(),p("button",{key:0,class:"btn btn-default btn-settings mb30",onClick:a[0]||(a[0]=(..._)=>t.finishStage&&t.finishStage(..._))},"\u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044C \u0440\u0435\u0433\u0430\u0442\u0443")):b("",!0)}const Ct=R(Vt,[["render",Tt]]),Rt={name:"stage.edit",components:{AppUsersTablesEdit:it,AppRaceTable:St,TheStageStatus:Ct,AppResultTable:Z,AppLoader:z,AppEditor:K,AppHeader:W},setup(){const o=d(!1),a=Q(),i=M(),t=a.params.id,f=d(),g=d(""),_=d(""),l=d(""),h=d(""),U=d(""),r=d(""),u=d(""),m=d(),s=d(),v=d(),x=d(),w=d(),G=d(null),j=d(),D=d(),E=d(),B=async c=>{try{const F=await y.get(`/api/admin/stage/${t}/meta`);j.value=F.data,s.value=c,D.value&&D.value.update(),E.value&&E.value.update()}catch(F){console.log(F.message)}},q=async()=>{try{const c=await y.get(`/api/admin/stage/${t}/edit`);m.value=c.data.users}catch(c){console.log(c.message)}};return N(async()=>{o.value=!0;try{const c=await y.get(`/api/admin/stage/${t}/edit`);h.value=f.value=c.data.title,g.value=c.data.register_start,_.value=c.data.register_end,l.value=c.data.race_start,U.value=c.data.excerpt?c.data.excerpt:" ",r.value=c.data.description?c.data.description:" ",u.value=c.data.participant_text?c.data.participant_text:" ",m.value=c.data.users,v.value=c.data.race_amount_drop,x.value=c.data.race_amount_group_drop,w.value=c.data.race_amount_fleet_drop,await B(c.data.status),o.value=!1,console.log("data",c.data)}catch(c){console.log(c.message),o.value=!1}}),{register_start:g,register_end:_,race_start:l,title:h,excerpt:U,description:r,submit:async()=>{o.value=!0;try{if(await y.patch(`/api/admin/stage/${t}/update`,{title:h.value,description:r.value,excerpt:U.value,participant_text:u.value,register_start:g.value,register_end:_.value,race_start:l.value,race_amount_drop:v.value,race_amount_group_drop:x.value,race_amount_fleet_drop:w.value}),G.value)for(let c of G.value)c.getTotal();i.dispatch("notification/displayMessage",{value:"\u042D\u0442\u0430\u043F \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D",type:"primary"}),o.value=!1}catch(c){console.log(c.message),i.dispatch("notification/displayMessage",{value:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u044D\u0442\u0430\u043F\u0430",type:"error"}),o.value=!1}},users:m,status:s,id:t,statusGroup:j,child:G,stageStatusComponent:E,race_amount_drop:v,race_amount_group_drop:x,race_amount_fleet_drop:w,statusGroupFetch:B,usersFetch:q,resultComponent:D,h1:f,loading:o,participant_text:u}}},Mt={class:"container-fluid g-0"},Gt={class:"row"},Dt={class:"col-12"},Et={class:"dashboard-item"},Ft={class:"form-control"},Nt=e("label",{for:"register_start"},"\u041D\u0430\u0447\u0430\u043B\u043E \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438",-1),jt={class:"form-control"},Bt=e("label",{for:"register_end"},"\u041A\u043E\u043D\u0435\u0446 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438",-1),Lt={class:"form-control"},$t=e("label",{for:"race_start"},"\u041D\u0430\u0447\u0430\u043B\u043E \u0433\u043E\u043D\u043E\u043A",-1),qt={class:"form-control"},Ht=e("label",{for:"title"},"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u042D\u0442\u0430\u043F\u0430",-1),Ot={class:"form-control"},Jt=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 (\u0434\u043E 18 \u0447\u0435\u043B\u043E\u0432)",-1),Pt={class:"form-control"},Qt=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432 \u0433\u0440\u0443\u043F\u043F\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)",-1),Xt={class:"form-control"},Yt=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432\u043E \u0444\u043B\u043E\u0442\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)",-1),Zt={class:"form-control"},zt=e("label",{for:"excerpt"},"\u041A\u0440\u0430\u0442\u043A\u043E\u0435 \u043E\u043F\u0438\u0441\u0430\u043D\u0438\u0435",-1),Kt={class:"form-control"},Wt=e("label",{for:"description"},"\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435",-1),te={class:"form-control"},ee=e("label",{for:"participant_text"},"\u0414\u043B\u044F \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u043E\u0432",-1),ae=e("button",{class:"btn btn-default btn-settings"},"\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",-1),se={class:"col-12"},oe={class:"dashboard-item"};function re(o,a,i,t,f,g){const _=T("AppHeader"),l=T("AppLoader"),h=T("AppEditor"),U=T("AppUsersTablesEdit"),r=T("AppRaceTable"),u=T("TheStageStatus"),m=T("AppResultTable");return n(),p(k,null,[$(_,null,{default:X(()=>[L(A(t.h1),1)]),_:1}),e("main",null,[e("div",Mt,[e("div",Gt,[e("div",Dt,[e("div",Et,[t.loading?(n(),V(l,{key:0})):b("",!0),e("form",{onSubmit:a[10]||(a[10]=Y((...s)=>t.submit&&t.submit(...s),["prevent"]))},[e("div",Ft,[Nt,I(e("input",{class:"form-input",type:"datetime-local",id:"register_start","onUpdate:modelValue":a[0]||(a[0]=s=>t.register_start=s)},null,512),[[S,t.register_start]])]),e("div",jt,[Bt,I(e("input",{class:"form-input",type:"datetime-local",id:"register_end","onUpdate:modelValue":a[1]||(a[1]=s=>t.register_end=s)},null,512),[[S,t.register_end]])]),e("div",Lt,[$t,I(e("input",{class:"form-input",type:"datetime-local",id:"race_start","onUpdate:modelValue":a[2]||(a[2]=s=>t.race_start=s)},null,512),[[S,t.race_start]])]),e("div",qt,[Ht,I(e("input",{class:"form-input",type:"text",id:"title","onUpdate:modelValue":a[3]||(a[3]=s=>t.title=s),placeholder:"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u044D\u0442\u0430\u043F\u0430"},null,512),[[S,t.title]])]),e("div",Ot,[Jt,I(e("input",{class:"form-input",type:"text",id:"race_amount_drop","onUpdate:modelValue":a[4]||(a[4]=s=>t.race_amount_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 (\u0434\u043E 18 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[S,t.race_amount_drop]])]),e("div",Pt,[Qt,I(e("input",{class:"form-input",type:"text",id:"race_amount_group_drop","onUpdate:modelValue":a[5]||(a[5]=s=>t.race_amount_group_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432 \u0433\u0440\u0443\u043F\u043F\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[S,t.race_amount_group_drop]])]),e("div",Xt,[Yt,I(e("input",{class:"form-input",type:"text",id:"race_amount_fleet_drop","onUpdate:modelValue":a[6]||(a[6]=s=>t.race_amount_fleet_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432\u043E \u0444\u043B\u043E\u0442\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[S,t.race_amount_fleet_drop]])]),e("div",Zt,[zt,t.excerpt?(n(),V(h,{key:0,modelValue:t.excerpt,"onUpdate:modelValue":a[7]||(a[7]=s=>t.excerpt=s),id:"excerpt"},null,8,["modelValue"])):b("",!0)]),e("div",Kt,[Wt,t.description?(n(),V(h,{key:0,modelValue:t.description,"onUpdate:modelValue":a[8]||(a[8]=s=>t.description=s),id:"description"},null,8,["modelValue"])):b("",!0)]),e("div",te,[ee,t.participant_text?(n(),V(h,{key:0,modelValue:t.participant_text,"onUpdate:modelValue":a[9]||(a[9]=s=>t.participant_text=s),id:"participant_text"},null,8,["modelValue"])):b("",!0)]),ae],32)])]),e("div",se,[e("div",oe,[t.status==="active"&&t.users?(n(),V(U,{key:0,users:t.users,id:t.id,status:t.status,onCreateGroups:t.statusGroupFetch,onUsersUpdated:t.usersFetch},null,8,["users","id","status","onCreateGroups","onUsersUpdated"])):b("",!0),t.status!=="finished"&&t.status!=="active"?(n(!0),p(k,{key:1},C(t.statusGroup,(s,v,x)=>(n(),p("div",{class:"stage-table",key:x},[(n(!0),p(k,null,C(s,w=>(n(),V(r,{stageId:t.id,groupId:w,status:v,key:w,ref_for:!0,ref:"child"},null,8,["stageId","groupId","status"]))),128))]))),128)):b("",!0),t.status!=="active"?(n(),V(u,{key:2,status:t.status,id:t.id,onUpdate:t.statusGroupFetch,ref:"stageStatusComponent"},null,8,["status","id","onUpdate"])):b("",!0),t.status!=="active"?(n(),V(m,{key:3,id:t.id,ref:"resultComponent"},null,8,["id"])):b("",!0)])])])])])],64)}const pe=R(Rt,[["render",re]]);export{pe as default};
