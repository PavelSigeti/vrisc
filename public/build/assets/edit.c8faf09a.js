import{_ as R,u as M,r as u,o as n,c as _,b as e,F as k,P as C,Q as A,g as B,S as I,Z as V,f as b,I as q,J as H,x as F,j as y,h as O,a as S,d as L,t as J,X as P,w as Q,e as T,U as X}from"./app.148b2c61.js";import{A as Z}from"./AppResultTable.4f81e7ed.js";import{A as z}from"./logo.6699aac8.js";import{A as K}from"./AppEditor.3fdea86d.js";import{A as W}from"./AppHeader.7c0e01f9.js";const Y=o=>(q("data-v-a297a062"),o=o(),H(),o),tt={key:0,class:"result-table"},et=Y(()=>e("thead",null,[e("tr",null,[e("th",null,"#"),e("th",null,"\u042F\u0445\u0442\u0441\u043C\u0435\u043D"),e("th",null,"\u0413\u0440\u0443\u043F\u043F\u0430"),e("th",null,"\u0423\u0434\u0430\u043B\u0435\u043D\u0438\u0435")])],-1)),at={class:"result-table__name"},st={class:"result-table__nick"},ot=["onUpdate:modelValue"],rt=["onClick"],nt={__name:"AppUsersTablesEdit",props:{id:{type:[String,Number],required:!0},users:{type:Array,default:()=>[]},status:{type:String,required:!0}},emits:["create-groups","users-updated"],setup(o,{emit:a}){const i=o,t=M(),f=u(i.status),g=u({});(r=>{const d={};r&&r.length>0&&r.forEach(m=>{d[m.id]=1}),g.value=d})(i.users);const l=()=>{if(!i.users.every(s=>g.value[s.id]!==void 0&&g.value[s.id]!==null&&g.value[s.id]>=1))return t.dispatch("notification/displayMessage",{type:"error",value:"\u041D\u0435 \u0432\u0441\u0435 \u044F\u0445\u0442\u0441\u043C\u0435\u043D\u044B \u0440\u0430\u0441\u043F\u0440\u0435\u0434\u0435\u043B\u0435\u043D\u044B \u043F\u043E \u0433\u0440\u0443\u043F\u043F\u0430\u043C"}),!1;const d=Object.values(g.value),m=[...new Set(d)].sort((s,v)=>s-v);for(let s=0;s<m.length;s++)if(m[s]!==s+1)return t.dispatch("notification/displayMessage",{type:"error",value:`\u041D\u043E\u043C\u0435\u0440\u0430 \u0433\u0440\u0443\u043F\u043F \u0434\u043E\u043B\u0436\u043D\u044B \u043D\u0430\u0447\u0438\u043D\u0430\u0442\u044C\u0441\u044F \u0441 1 \u0438 \u0438\u0434\u0442\u0438 \u043F\u043E\u0441\u043B\u0435\u0434\u043E\u0432\u0430\u0442\u0435\u043B\u044C\u043D\u043E. \u041E\u0431\u043D\u0430\u0440\u0443\u0436\u0435\u043D\u0430 \u0433\u0440\u0443\u043F\u043F\u0430 \u2116${m[s]}`}),!1;return!0},h=async()=>{var r,d,m,s;try{if(!l())return;const v={};i.users.forEach(w=>{v[w.id]=parseInt(g.value[w.id])||1});const x=await axios.post(`/api/admin/stage/${i.id}/create-manual-groups`,{groups:v});x.data.result?(f.value=x.data.status,a("create-groups",x.data.status),t.dispatch("notification/displayMessage",{type:"primary",value:"\u0413\u0440\u0443\u043F\u043F\u044B \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u0441\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u044B \u0438 \u044D\u0442\u0430\u043F \u043D\u0430\u0447\u0430\u0442"})):t.dispatch("notification/displayMessage",{type:"error",value:x.data.msg||x.data.error||"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0438 \u0433\u0440\u0443\u043F\u043F"})}catch(v){console.error("Error creating groups:",v),t.dispatch("notification/displayMessage",{type:"error",value:((d=(r=v.response)==null?void 0:r.data)==null?void 0:d.message)||((s=(m=v.response)==null?void 0:m.data)==null?void 0:s.msg)||"\u041E\u0448\u0438\u0431\u043A\u0430 \u0441\u0435\u0440\u0432\u0435\u0440\u0430"})}},U=async r=>{const d=await axios.post(`/api/admin/stage/${i.id}/remove-user/${r}`);d.data.result?(a("users-updated"),t.dispatch("notification/displayMessage",{type:"primary",value:"\u0423\u0447\u0430\u0441\u0442\u043D\u0438\u043A \u0443\u0434\u0430\u043B\u0435\u043D"})):t.dispatch("notification/displayMessage",{type:"error",value:d.data.msg})};return(r,d)=>(n(),_(k,null,[i.users&&i.users.length>0?(n(),_("table",tt,[et,e("tbody",null,[(n(!0),_(k,null,C(i.users,(m,s)=>(n(),_("tr",{key:m.id||s},[e("td",null,A(s+1),1),e("td",null,[e("div",at,[B(A(m.surname)+" "+A(m.name)+" ",1),e("span",st,A(m.nickname),1)])]),e("td",null,[I(e("input",{class:"split-number-input",type:"number","onUpdate:modelValue":v=>g.value[m.id]=v,min:"1"},null,8,ot),[[V,g.value[m.id]]])]),e("td",null,[e("button",{class:"btn btn-default btn-settings",onClick:v=>U(m.id)},"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",8,rt)])]))),128))])])):b("",!0),i.users&&i.users.length>0?(n(),_("button",{key:1,class:"btn btn-default btn-settings mt15",onClick:h}," \u0421\u0444\u043E\u0440\u043C\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u0433\u0440\u0443\u043F\u043F\u044B ")):b("",!0)],64))}},lt=R(nt,[["__scopeId","data-v-a297a062"]]),it={name:"AppRaceColumn",props:["raceId"],emits:["update"],setup(o,{emit:a}){const i=M(),t=u([]),f=u(0);return F(async()=>{const p=await y.get(`/api/admin/race/${o.raceId}`);t.value=p.data,f.value=Object.keys(t.value).length+1}),{submit:async()=>{try{await y.post(`/api/admin/race/${o.raceId}/results`,{result:t.value}),i.dispatch("notification/displayMessage",{value:"\u0414\u0430\u043D\u043D\u044B\u0435 \u0433\u043E\u043D\u043A\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u044B",type:"primary"}),a("update")}catch{i.dispatch("notification/displayMessage",{value:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u0434\u0430\u043D\u043D\u044B\u0445 \u0433\u043E\u043D\u043A\u0438",type:"error"})}},result:t,userAmount:f}}},ct=["onUpdate:modelValue","placeholder"],dt={class:"race-table__item race-table__result"};function ut(o,a,i,t,f,g){return n(),_(k,null,[(n(!0),_(k,null,C(t.result,(p,l)=>(n(),_("div",{class:"race-table__item race-table__result",key:l},[I(e("input",{type:"text","onUpdate:modelValue":h=>t.result[l]=h,placeholder:`(dnf, ${t.userAmount})`},null,8,ct),[[V,t.result[l]]])]))),128)),e("div",dt,[e("button",{onClick:a[0]||(a[0]=(...p)=>t.submit&&t.submit(...p))},"\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C")])],64)}const pt=R(it,[["render",ut]]),_t={name:"AppRaceTable",props:["stageId","status","groupId"],components:{AppRaceColumn:pt},setup(o){const a=u({}),i=u({}),t=u(),f=u(),g=u({default:"\u0413\u043E\u043D\u043A\u0430",group:"\u0413\u0440\u0443\u043F\u043F\u0430",fleet:"\u0424\u043B\u043E\u0442"}),p=O(()=>{var r;return(r=Object.keys(a.value).length)!=null?r:0}),l=async()=>{try{const r=await y.get(`/api/admin/stage/${o.stageId}/${o.groupId}/${o.status}/total`);f.value=r.data}catch(r){console.log(r.message)}};return F(async()=>{try{const r=await y.get(`/api/admin/stage/${o.stageId}/races/${o.status}/group/${o.groupId}`);a.value=r.data,t.value=a.value[0].race_id;const d=await y.get(`/api/admin/race/${t.value}/users`);i.value=d.data,await l()}catch(r){console.log(r.message)}}),{raceData:a,raceAmount:p,usersData:i,addRace:async()=>{try{const d=(await y.post("/api/admin/race/create",{stage_id:o.stageId,group_id:o.groupId,status:o.status,lastRaceId:t.value})).data;a.value.push({race_id:d.id,group_id:d.group_id,status:d.status}),await l()}catch(r){console.log(r.message)}},remove:async r=>{try{await y.post(`/api/admin/race/${r}/remove`),a.value.splice(a.value.findIndex(d=>d.race_id===r),1),await l()}catch(d){console.log(d.message)}},totalData:f,getTotal:l,raceTitle:g}}},mt={class:"race-table"},gt={key:0},vt={class:"race-table__header"},ft={class:"race-table__row"},ht=e("div",{class:"race-table__item race-table__name"},"\u042F\u0445\u0442\u0441\u043C\u0435\u043D",-1),bt=e("div",{class:"race-table__item race-table__total"},"\u0418\u0442\u043E\u0433",-1),yt={class:"race-table__body"},xt={class:"race-table__column"},kt={key:0,class:"race-table__item race-table__result"},At=["onClick"],Ut={class:"race-table__column"};function wt(o,a,i,t,f,g){const p=S("AppRaceColumn");return n(),_("div",mt,[o.$props.status?(n(),_("h2",gt,A(t.raceTitle[o.$props.status])+" #"+A(o.$props.groupId),1)):b("",!0),e("button",{class:"btn btn-default btn-settings mb15",onClick:a[0]||(a[0]=(...l)=>t.addRace&&t.addRace(...l))},"\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C \u0433\u043E\u043D\u043A\u0443"),e("div",vt,[e("div",ft,[ht,(n(!0),_(k,null,C(t.raceAmount,l=>(n(),_("div",{class:"race-table__item race-table__result",key:l},"#"+A(l),1))),128)),bt])]),e("div",yt,[e("div",xt,[(n(!0),_(k,null,C(t.usersData,l=>(n(),_("div",{class:"race-table__item race-table__name",key:l.user_id},A(l.nickname),1))),128))]),(n(!0),_(k,null,C(t.raceData,(l,h)=>(n(),_("div",{class:"race-table__column",key:l.race_id},[L(p,{raceId:l.race_id,onUpdate:t.getTotal},null,8,["raceId","onUpdate"]),t.raceData.length>1&&h+1!==1?(n(),_("div",kt,[e("button",{onClick:U=>t.remove(l.race_id)},"\u0423\u0434\u0430\u043B\u0438\u0442\u044C",8,At)])):b("",!0)]))),128)),e("div",Ut,[(n(!0),_(k,null,C(t.totalData,(l,h)=>(n(),_("div",{class:"race-table__item race-table__total",key:h},A(l),1))),128))])])])}const It=R(_t,[["render",wt]]),Vt={name:"TheStageStatus",emits:["update"],props:["status","id"],setup(o,{emit:a}){const i=u(o.status),t=o.id,f=M();return J(()=>o.status,p=>{i.value=p},{immediate:!0}),{status:i,id:t,finishStage:async()=>{try{const p=await y.post(`/api/admin/stage/${t}/finish`);i.value=p.data.status,a("update",i.value)}catch(p){console.log(p.message),f.dispatch("notification/displayMessage",{value:p.response.data.message,type:"error"})}}}}};function Tt(o,a,i,t,f,g){return t.status==="default"||t.status==="group"?(n(),_("button",{key:0,class:"btn btn-default btn-settings mb30",onClick:a[0]||(a[0]=(...p)=>t.finishStage&&t.finishStage(...p))},"\u0417\u0430\u0432\u0435\u0440\u0448\u0438\u0442\u044C \u0440\u0435\u0433\u0430\u0442\u0443")):b("",!0)}const St=R(Vt,[["render",Tt]]),Ct={name:"stage.edit",components:{AppUsersTablesEdit:lt,AppRaceTable:It,TheStageStatus:St,AppResultTable:Z,AppLoader:z,AppEditor:K,AppHeader:W},setup(){const o=u(!1),a=P(),i=M(),t=a.params.id,f=u(),g=u(""),p=u(""),l=u(""),h=u(""),U=u(""),r=u(""),d=u(""),m=u(),s=u(),v=u(),x=u(),w=u(),G=u(null),N=u(),D=u(),j=async c=>{try{const E=await y.get(`/api/admin/stage/${t}/meta`);N.value=E.data,s.value=c,D.value&&D.value.update()}catch(E){console.log(E.message)}},$=async()=>{try{const c=await y.get(`/api/admin/stage/${t}/edit`);m.value=c.data.users}catch(c){console.log(c.message)}};return F(async()=>{o.value=!0;try{const c=await y.get(`/api/admin/stage/${t}/edit`);h.value=f.value=c.data.title,g.value=c.data.register_start,p.value=c.data.register_end,l.value=c.data.race_start,U.value=c.data.excerpt?c.data.excerpt:" ",r.value=c.data.description?c.data.description:" ",d.value=c.data.participant_text?c.data.participant_text:" ",m.value=c.data.users,v.value=c.data.race_amount_drop,x.value=c.data.race_amount_group_drop,w.value=c.data.race_amount_fleet_drop,await j(c.data.status),o.value=!1,console.log("data",c.data)}catch(c){console.log(c.message),o.value=!1}}),{register_start:g,register_end:p,race_start:l,title:h,excerpt:U,description:r,submit:async()=>{o.value=!0;try{if(await y.patch(`/api/admin/stage/${t}/update`,{title:h.value,description:r.value,excerpt:U.value,participant_text:d.value,register_start:g.value,register_end:p.value,race_start:l.value,race_amount_drop:v.value,race_amount_group_drop:x.value,race_amount_fleet_drop:w.value}),G.value)for(let c of G.value)c.getTotal();i.dispatch("notification/displayMessage",{value:"\u042D\u0442\u0430\u043F \u0443\u0441\u043F\u0435\u0448\u043D\u043E \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D",type:"primary"}),o.value=!1}catch(c){console.log(c.message),i.dispatch("notification/displayMessage",{value:"\u041E\u0448\u0438\u0431\u043A\u0430 \u043F\u0440\u0438 \u043E\u0431\u043D\u043E\u0432\u043B\u0435\u043D\u0438\u0438 \u044D\u0442\u0430\u043F\u0430",type:"error"}),o.value=!1}},users:m,status:s,id:t,statusGroup:N,child:G,race_amount_drop:v,race_amount_group_drop:x,race_amount_fleet_drop:w,statusGroupFetch:j,usersFetch:$,resultComponent:D,h1:f,loading:o,participant_text:d}}},Rt={class:"container-fluid g-0"},Mt={class:"row"},Gt={class:"col-12"},Dt={class:"dashboard-item"},Et={class:"form-control"},Ft=e("label",{for:"register_start"},"\u041D\u0430\u0447\u0430\u043B\u043E \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438",-1),Nt={class:"form-control"},jt=e("label",{for:"register_end"},"\u041A\u043E\u043D\u0435\u0446 \u0440\u0435\u0433\u0438\u0441\u0442\u0440\u0430\u0446\u0438\u0438",-1),Bt={class:"form-control"},Lt=e("label",{for:"race_start"},"\u041D\u0430\u0447\u0430\u043B\u043E \u0433\u043E\u043D\u043E\u043A",-1),$t={class:"form-control"},qt=e("label",{for:"title"},"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u042D\u0442\u0430\u043F\u0430",-1),Ht={class:"form-control"},Ot=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 (\u0434\u043E 18 \u0447\u0435\u043B\u043E\u0432)",-1),Jt={class:"form-control"},Pt=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432 \u0433\u0440\u0443\u043F\u043F\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)",-1),Qt={class:"form-control"},Xt=e("label",{for:"race_amount_drop"},"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432\u043E \u0444\u043B\u043E\u0442\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)",-1),Zt={class:"form-control"},zt=e("label",{for:"excerpt"},"\u041A\u0440\u0430\u0442\u043A\u043E\u0435 \u043E\u043F\u0438\u0441\u0430\u043D\u0438\u0435",-1),Kt={class:"form-control"},Wt=e("label",{for:"description"},"\u041E\u043F\u0438\u0441\u0430\u043D\u0438\u0435",-1),Yt={class:"form-control"},te=e("label",{for:"participant_text"},"\u0414\u043B\u044F \u0443\u0447\u0430\u0441\u0442\u043D\u0438\u043A\u043E\u0432",-1),ee=e("button",{class:"btn btn-default btn-settings"},"\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C",-1),ae={class:"col-12"},se={class:"dashboard-item"};function oe(o,a,i,t,f,g){const p=S("AppHeader"),l=S("AppLoader"),h=S("AppEditor"),U=S("AppUsersTablesEdit"),r=S("AppRaceTable"),d=S("TheStageStatus"),m=S("AppResultTable");return n(),_(k,null,[L(p,null,{default:Q(()=>[B(A(t.h1),1)]),_:1}),e("main",null,[e("div",Rt,[e("div",Mt,[e("div",Gt,[e("div",Dt,[t.loading?(n(),T(l,{key:0})):b("",!0),e("form",{onSubmit:a[10]||(a[10]=X((...s)=>t.submit&&t.submit(...s),["prevent"]))},[e("div",Et,[Ft,I(e("input",{class:"form-input",type:"datetime-local",id:"register_start","onUpdate:modelValue":a[0]||(a[0]=s=>t.register_start=s)},null,512),[[V,t.register_start]])]),e("div",Nt,[jt,I(e("input",{class:"form-input",type:"datetime-local",id:"register_end","onUpdate:modelValue":a[1]||(a[1]=s=>t.register_end=s)},null,512),[[V,t.register_end]])]),e("div",Bt,[Lt,I(e("input",{class:"form-input",type:"datetime-local",id:"race_start","onUpdate:modelValue":a[2]||(a[2]=s=>t.race_start=s)},null,512),[[V,t.race_start]])]),e("div",$t,[qt,I(e("input",{class:"form-input",type:"text",id:"title","onUpdate:modelValue":a[3]||(a[3]=s=>t.title=s),placeholder:"\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u044D\u0442\u0430\u043F\u0430"},null,512),[[V,t.title]])]),e("div",Ht,[Ot,I(e("input",{class:"form-input",type:"text",id:"race_amount_drop","onUpdate:modelValue":a[4]||(a[4]=s=>t.race_amount_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 (\u0434\u043E 18 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[V,t.race_amount_drop]])]),e("div",Jt,[Pt,I(e("input",{class:"form-input",type:"text",id:"race_amount_group_drop","onUpdate:modelValue":a[5]||(a[5]=s=>t.race_amount_group_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432 \u0433\u0440\u0443\u043F\u043F\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[V,t.race_amount_group_drop]])]),e("div",Qt,[Xt,I(e("input",{class:"form-input",type:"text",id:"race_amount_fleet_drop","onUpdate:modelValue":a[6]||(a[6]=s=>t.race_amount_fleet_drop=s),placeholder:"\u041A\u043E\u043B-\u0432\u043E \u0432\u044B\u0431\u0440\u043E\u0441\u043E\u0432 \u0432\u043E \u0444\u043B\u043E\u0442\u0430\u0445 (\u043E\u0442 19 \u0447\u0435\u043B\u043E\u0432)"},null,512),[[V,t.race_amount_fleet_drop]])]),e("div",Zt,[zt,t.excerpt?(n(),T(h,{key:0,modelValue:t.excerpt,"onUpdate:modelValue":a[7]||(a[7]=s=>t.excerpt=s),id:"excerpt"},null,8,["modelValue"])):b("",!0)]),e("div",Kt,[Wt,t.description?(n(),T(h,{key:0,modelValue:t.description,"onUpdate:modelValue":a[8]||(a[8]=s=>t.description=s),id:"description"},null,8,["modelValue"])):b("",!0)]),e("div",Yt,[te,t.participant_text?(n(),T(h,{key:0,modelValue:t.participant_text,"onUpdate:modelValue":a[9]||(a[9]=s=>t.participant_text=s),id:"participant_text"},null,8,["modelValue"])):b("",!0)]),ee],32)])]),e("div",ae,[e("div",se,[t.status==="active"&&t.users?(n(),T(U,{key:0,users:t.users,id:t.id,status:t.status,onCreateGroups:t.statusGroupFetch,onUsersUpdated:t.usersFetch},null,8,["users","id","status","onCreateGroups","onUsersUpdated"])):b("",!0),t.status!=="finished"&&t.status!=="active"?(n(!0),_(k,{key:1},C(t.statusGroup,(s,v,x)=>(n(),_("div",{class:"stage-table",key:x},[(n(!0),_(k,null,C(s,w=>(n(),T(r,{stageId:t.id,groupId:w,status:v,key:w,ref_for:!0,ref:"child"},null,8,["stageId","groupId","status"]))),128))]))),128)):b("",!0),t.status!=="active"?(n(),T(d,{key:2,status:t.status,id:t.id,onUpdate:t.statusGroupFetch},null,8,["status","id","onUpdate"])):b("",!0),t.status!=="active"?(n(),T(m,{key:3,id:t.id,ref:"resultComponent"},null,8,["id"])):b("",!0)])])])])])],64)}const ue=R(Ct,[["render",oe]]);export{ue as default};
